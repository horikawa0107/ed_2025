<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>センサーデータ表示{{room_name}}</title>
    <style>
        .header {
            background-color: #87cefa; /* 青 */
            color: black;
            padding: 60px;
        }
    </style>
</head>
<body>
    <h1 style="text-align:center" class="header">快適指数モニター：{{room_name}}</h1>
    <p>データ総件数: <span id="count">{{ data_count }}</span></p>
    <p>
        現在の予測快適指数: <span id="comfort">{{ predicted_data.score }}</span>
</p>
<table border="1">
    <tr><th>日時</th><td id="time">{{ latest_data.timestamp }}</td></tr>
    <tr><th>温度[°C]</th><td id="temp">{{ latest_data.avg_temperature }}</td></tr>
    <tr><th>湿度[%]</th><td id="hum">{{ latest_data.avg_humidity }}</td></tr>
    <tr><th>照度[lx]</th><td id="light">{{ latest_data.avg_light }}</td></tr>
    <tr><th>気圧[hPa]</th><td id="pres">{{ latest_data.avg_pressure }}</td></tr>
    <tr><th>騒音度[dB]</th><td id="sound">{{ latest_data.avg_sound_level }}</td></tr>
    <tr><th>バッテリー[V]</th><td id="batt">{{ latest_data.battery }}</td></tr>
</table>
    <p>アドバイス: <span id="advice">{{ predicted_data.advice }}</span></p>
<div>
        <button onclick="window.location.href='/'"
                style="
                    padding: 12px 25px;
                    font-size: 18px;
                    margin: 20px 0;
                    border-radius: 8px;
                    background-color: #dcdcdc;
                    color: black;
                    border: none;
                    cursor: pointer;
                ">
            ← 部屋一覧に戻る
        </button>
    </div>


    <h2>センサーデータログ</h2>
<table border="1">
    <tr>
        <th>日時</th><th>温度[°C]</th><th>湿度[%]</th><th>照度[lx]</th><th>気圧[hPa]</th><th>騒音度[dB]</th><th>バッテリー[V]</th>
    </tr>
    <tbody id="log-table-body">
        {% for data_for_log in datas_for_log %}
        <tr>
            <td>{{ data_for_log.timestamp }}</td>
            <td>{{ data_for_log.avg_temperature }}</td>
            <td>{{ data_for_log.avg_humidity }}</td>
            <td>{{ data_for_log.avg_light }}</td>
            <td>{{ data_for_log.avg_pressure }}</td>
            <td>{{ data_for_log.avg_sound_level }}</td>
            <td>{{ data_for_log.battery }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</body>
</html>

<script>
const roomId = "{{ room_id }}";


function formatTimestamp(ts) {
    const d = new Date(ts); // どんな形式でも Date に任せる

    if (isNaN(d)) {
        console.error("Invalid timestamp:", ts);
        return ts;  // 変換できない場合はそのまま返す
    }

    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const mi = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');

    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}

async function fetchLatestData() {
    const response = await fetch(`/api/latest/${roomId}`);
    const data = await response.json();

    // 最新データをHTMLに反映
    document.querySelector("#temp").textContent = data.latest_data.avg_temperature;
    document.querySelector("#hum").textContent = data.latest_data.avg_humidity;
    document.querySelector("#light").textContent = data.latest_data.avg_light;
    document.querySelector("#pres").textContent = data.latest_data.avg_pressure;
    document.querySelector("#sound").textContent = data.latest_data.avg_sound_level;
    document.querySelector("#batt").textContent = data.latest_data.battery;
    document.querySelector("#comfort").textContent = data.predicted_data.score;
    document.querySelector("#advice").textContent = data.predicted_data.advice;
    document.querySelector("#count").textContent = data.data_count;

    document.querySelector("#time").textContent =
        formatTimestamp(data.latest_data.timestamp);

    // === ログテーブルを再描画 ===
    const logTable = document.querySelector("#log-table-body");
    logTable.innerHTML = ""; // 一旦クリア

    data.datas_for_log.forEach(log => {
        const row = `
            <tr>
                <td>${formatTimestamp(log.timestamp)}</td>
                <td>${log.avg_temperature}</td>
                <td>${log.avg_humidity}</td>
                <td>${log.avg_light}</td>
                <td>${log.avg_pressure}</td>
                <td>${log.avg_sound_level}</td>
                <td>${log.battery}</td>
            </tr>
        `;
        logTable.innerHTML += row;
    });

}

// 5秒ごとに更新
setInterval(fetchLatestData, 10000);
</script>

